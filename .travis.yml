sudo: required

language: python # Required for Deployment Script

services:
  - docker

before_install:
  - docker --version                      # Write the Docker Version to the Log
  - pip install --user awscli             # Install the AWS CLI
  - export PATH=$PATH:HOME/.local/bin     # Put the AWS CLI in the path

script:
  - docker build -t ecr-hello-world .     # Build the docker image
  - docker run -d -p 8080 ecr-hello-world # Ensure that it runs
  - docker ps -a                          # Log running containers.
  - eval $(aws ecr get-login --region ${AWS_ECR_REPO_REGION}) # Log in to ECR
  - docker tag ecr-hello-world:${TRAVIS_TAG:-${TRAVIS_COMMIT}}
    ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_ECR_REPO_REGION}.amazonaws.com/${AWS_ECR_REPO_NAME}:${TRAVIS_TAG:-${TRAVIS_COMMIT}}
  - docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_ECR_REPO_REGION}.amazonaws.com/${AWS_ECR_REPO_NAME}:${TRAVIS_TAG:-${TRAVIS_COMMIT}}
  - python3 scripts/generate_task_definition.py
    --input-file task-definition.json
    --output-file task-definition-final.json
    --tag ${TRAVIS_TAG:-latest}
    --environment ${TRAVIS_TAG+prod}

after_success: true

deploy:
  provider: script
  script: scripts/deploy.sh --enviroment production --tag $TRAVIS_TAG
  on:
    tags: true # Deploy when a Release is created in GitHub.
